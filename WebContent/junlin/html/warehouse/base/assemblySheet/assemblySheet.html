<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8" />
		<title>组装单</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="../../../../css/bootstrap.min.css" />
		<link rel="stylesheet" href="../../../../css/ace.min.css" />
		<link rel="stylesheet" href="../../../../css/style.css" />
		<link rel="stylesheet" href="../../../../css/style_i.css" />
		<link rel="stylesheet" href="../../../../font/css/font-awesome.min.css" />
		<link rel="stylesheet" href="../../../../js/layer/skin/layer.css" />
		<!--[if IE 7]>
		  <link rel="stylesheet" href="../../../../font/css/font-awesome-ie7.min.css" />
		  <link rel="stylesheet" href="../../../../css/ace-ie.min.css" />
		<![endif]-->

		<link rel="stylesheet" href="../../../../css/mine/all.css" />
		<link rel="stylesheet" href="../../../../css/mine/public.css" />

		<script src="../../../../js/jquery-1.10.2.min.js"></script>
		<script src="../../../../js/bootstrap.min.js"></script>
		<script src="../../../../js/typeahead-bs2.min.js"></script>
		<script src="../../../../js/jquery.dataTables.min.js"></script>
		<script src="../../../../js/jquery.dataTables.bootstrap.js"></script>
		<script src="../../../../js/layer/layer.js" type="text/javascript"></script>
		<script src="../../../../js/laydate/laydate.js" type="text/javascript"></script>

		<script src="../../../../script/public.js" type="text/javascript"></script>

		<link href="../../../../js/jQuery-searchableSelect/jquery.searchableSelect.css" rel="stylesheet" type="text/css">
		<script src="../../../../js/jQuery-searchableSelect/jquery.searchableSelect.js"></script>

		<style type="text/css">
			#allgoodDivEdit .jl-panel {
				position: relative;
			}
			
			#detailDiv,
			#editDiv {
				margin: 50px auto;
			}
			
			.col-xs-5 {
				text-align: left !important;
			}
		</style>

	</head>

	<body class="content">
		<div class="page-content clearfix">
			<div id="Member_Ratings">
				<div class="d_Confirm_Order_style" style="margin-top:10px;">
					<h4 class="text-title">组装单</h4>
					<div class="search-div clearfix">
						<div class="clearfix">
							<span class="l_f"> 
							仓库： <select class="warehouse">
								<option value="-1">--全部仓库--</option>
							</select>
							</span>
							<span class="l_f"> 
								日期： <input type="text"  value="" id="dateSearch" placeholder="请选择日期" readonly="readonly" />
							</span>
							<span class="l_f"> 
								制单人： <input type="text"  value="" onblur="cky(this)" />
							</span>
							<span class="r_f"> 
								<input type="button"  class="btncss btn_search" value="搜索" />
							</span>
						</div>

					</div>
					<div class="opration-div clearfix">

						<span class="r_f"> 
							<button type="button" class="btncss jl-btn-defult" onclick="assemblySheetAdd()"><i class="fa fa-plus"></i> 新增</button>
						</span>

					</div>
					<div class="table_menu_list">
						<table class="table table-striped table-hover col-xs-12" id="datatable">
							<thead class="table-header">
								<tr>
									<th>单号</th>
									<th>日期</th>
									<th>仓库</th>
									<th>货品名称</th>
									<th>组装数量</th>
									<th>金额</th>
									<th>状态</th>
									<th width="25%">操作</th>
								</tr>

							</thead>
							<tbody>
								<tr>
									<td>
										<span class="look-span" onclick="assemblySheetDetail()">PO.2017.09.00054</span>
									</td>
									<td>冷库</td>
									<td>AAA</td>
									<td>212454878</td>
									<td>212454878</td>
									<td>212454878</td>
									<td>2017.10.02</td>
									<td>
										<input type="button" class="btncss edit" onclick="assemblySheetModify()" value="编辑" />
										<input type="button" class="btncss edit" onclick="assemblySheetDel()" value="删除" />
										<input type="button" class="btncss edit" onclick="sendTo()" value="送审" />
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!--详情 -->
		<div id="detailDiv" style="display: none;">
			<div class="print-content">

				<form class="container">
					<h3 class="print-title">组装单</h3>
					<div class="row">
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">仓库：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">货品编码：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">货品名称：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">规格：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">单位：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">单价：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">组装数量：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">金额：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
					</div>
					<div id="allgoodDivDetail">
						<table class="table table-bordered table-striped table-hover col-xs-12" border="" cellspacing="0" cellpadding="0">
							<tbody>
								<tr>
									<th>货品编码</th>
									<th>货品名称</th>
									<th>规格</th>
									<th>单位</th>
									<th>数量</th>
									<th>单价</th>
									<th>金额</th>
								</tr>
								<tr>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
								</tr>
							</tbody>
						</table>

					</div>
					<div class="row">
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">部门：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">业务员：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">制单人：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">摘要：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
						<div class="col-xs-4">
							<div class="form-group">
								<label for="" class="col-xs-5 control-label">审核人：</label>
								<div class="col-xs-7">

								</div>
							</div>
						</div>
					</div>

				</form>

			</div>
		</div>

		<div id="editDiv" style="display: none;">
			<form class="container">
				<div class="row jl-title">
					<span>组装商品信息</span>
				</div>
				<div id="headEdit" class="jl-panel">
					<div class="row">
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">货品名称</label>
								<div class="col-xs-8">
									<select class="form-control" id="edit_giftBox">
										<option value="-1">--请选择货品--</option>
										<option value="A">A货品</option>
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">货品编码</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" placeholder="请先选择货品" disabled="disabled" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">规格</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" placeholder="请先选择货品" disabled="disabled" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">单位</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" placeholder="请先选择货品" disabled="disabled" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">单价</label>
								<div class="col-xs-8">
									<input type="text" id="unitPrice" class="form-control" placeholder="请先选择货品" disabled="disabled" value="10" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">组装数量</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" onkeyup="countMoney(this)" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">金额</label>
								<div class="col-xs-8">
									<input type="text" id="amountMoney" class="form-control" placeholder="请先填写组装数量" disabled="disabled" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">仓库</label>
								<div class="col-xs-8">
									<select class="form-control">
										<option value="-1">--请选择仓库--</option>
										<option value="A">A仓库</option>
									</select>
								</div>
							</div>
						</div>
					</div>

				</div>

				<div class="row">
					<div class="jl-title l_f" style="text-align: left;">
						<span>货品</span>
					</div>
					<div class="r_f">
						<button type="button" class="btncss jl-btn-importent" onclick="goodsAddEdit()">新增</button>
					</div>
					<div class="r_f">
						<div class="form-group">
							<div class="col-xs-8">
								<select id="edit_goods" class="form-control">
									<option value="-1">--请选择货品--</option>
									<option value="44" attr-name="name" attr-type="type" attr-unit="unit" attr-price="10">44</option>
									<option value="11" attr-name="name" attr-type="type" attr-unit="unit" attr-price="10">11</option>
									<option value="33" attr-name="name" attr-type="type" attr-unit="unit" attr-price="10">33</option>
								</select>
							</div>
						</div>
					</div>

				</div>
				<table class="table table-bordered table-striped table-hover col-xs-12" border="" cellspacing="0" cellpadding="0">
					<tbody id="goodsTbody">
						<tr>
							<th>货品编码</th>
							<th>货品名称</th>
							<th>规格</th>
							<th>单位</th>
							<th>数量</th>
							<th>单价</th>
							<th>金额</th>
							<th>操作</th>
						</tr>
						<tr class="tipTr">
							<td colspan="8">请先选择商品</td>
						</tr>
					</tbody>
				</table>
				<div class="row jl-title">
					<span>其他</span>
				</div>
				<div id="footerEdit" class="jl-panel">
					<div class="row">
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">部门</label>
								<div class="col-xs-8">
									<select class="form-control">
										<option value="-1">--请选择部门--</option>
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">业务员</label>
								<div class="col-xs-8">
									<select class="form-control">
										<option value="-1">--请选择业务员--</option>
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">制单人</label>
								<div class="col-xs-8">
									<input class="form-control" type="text" onblur="cky(this)" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">摘要</label>
								<div class="col-xs-8">
									<input class="form-control" type="text" onblur="cky(this)" />
								</div>
							</div>
						</div>
					</div>
				</div>
			</form>
		</div>

	</body>

	<script>
		let goodsArr = [];
		$(function() {
			latdate("#dateSearch");

			$('#edit_goods').searchableSelect();
			$('#edit_giftBox').searchableSelect();

		})
		/*新增*/
		function assemblySheetAdd() {
			layer.open({
				type: 1,
				title: "新增组装单",
				closeBtn: 1,
				area: ['100%', '100%'],
				content: $("#editDiv"),
				btn: ['提交', '取消'],
				yes: function(index) {
					layer.close(index);

					laysuccess("新增");
					clearForm("editDiv", "");
				},
				end: function(index, layero) {
					layer.close(index);
					clearForm("editDiv", "");
					clearGoods();
					clearSearchableSelect("edit_goods");
					clearSearchableSelect("edit_giftBox");
				}
			});
		}

		/*编辑*/
		function assemblySheetModify() {
			layer.open({
				type: 1,
				title: "编辑组装单",
				closeBtn: 1,
				area: ['100%', '100%'],
				content: $("#editDiv"),
				btn: ['提交', '取消'],
				yes: function(index) {
					layer.close(index);

					laysuccess("编辑完成");
					clearForm("editDiv", "");
				},
				end: function(index, layero) {
					layer.close(index);
					clearForm("editDiv", "");
					clearGoods();
					clearSearchableSelect("edit_goods");
					clearSearchableSelect("edit_giftBox");
				}
			});
		}

		/*详情*/
		function assemblySheetDetail() {
			layer.open({
				type: 1,
				title: "组装单详情",
				closeBtn: 1,
				area: ['100%', '100%'],
				content: $("#detailDiv"),
				btn: ['关闭']
			});
		}

		/*删除*/

		function assemblySheetDel() {
			publicMessageLayer("删除所选单据", function() {
				/*请在此处添加删除操作*/
				laysuccess("已删除");
			})
		}

		/*送审*/
		function sendTo() {
			publicMessageLayer("送审", function() {
				/*请在此处添加发送操作*/
				laysuccess("已送审");
			})
		}

		/*添加商品*/
		function goodsAddEdit() {
			let goodsId = $("#edit_goods").val();
			let name = $("#edit_goods option:selected").attr("attr-name");
			let type = $("#edit_goods option:selected").attr("attr-type");
			let unit = $("#edit_goods option:selected").attr("attr-unit");
			let price = $("#edit_goods option:selected").attr("attr-price");

			if(goodsId == -1) {
				layfail("请先选择商品!");
			} else if(!checkRepeat(goodsId)) {
				$(".tipTr").remove();
				goodsArr.push(goodsId);
				$("#goodsTbody").append('<tr><td class="goodsId">' + goodsId + '</td><td>' + name + '</td><td>' + type + '</td><td>' + unit + '</td>' +
					'<td><input type="text" class="form-control" onkeyup="countGoodsMoney(this)"/></td><td class="goodsUnitPrice">' + price + '</td>' +
					'<td><input type="text" class="goodsAllPrice form-control" placeholder="请先填写数量" disabled="disabled"/></td>' +
					'<td><input type="button" class="btncss edit" onclick="goodsDel(this)" value="删除" /></td></tr>');
			} else {
				layfail("请勿重复选择商品！");
			}
		}

		/*删除商品*/
		function goodsDel(thisbtn) {
			let goodsId = $(thisbtn).parents("tr").find(".goodsId").html();
			goodsArr.remove(goodsId);
			$(thisbtn).parents("tr").remove();
			if($("#goodsTbody tr").length == 1) {
				$("#goodsTbody").append('<tr class="tipTr"><td colspan="8">请先选择商品</td></tr>');
			}
		}

		/*查重*/
		function checkRepeat(id) {
			let flag = false;
			for(var i in goodsArr) {
				if(goodsArr[i] == id) {
					flag = true;
				}
			}
			return flag;
		}

		/*清空商品*/
		function clearGoods() {
			$("#goodsTbody").html('<tr><th>货品编码</th><th>货品名称</th><th>规格</th><th>单位</th><th>数量</th><th>单价</th><th>金额</th><th>操作</th></tr>' +
				'<tr class="tipTr"><td colspan="8">请先选择商品</td></tr>');
			goodsArr = [];
		}

		/*计算总金额*/
		function countMoney(thisInput) {
			
			if(isnotEmpty($(thisInput).val())){
				pressInteger(thisInput);
				$("#amountMoney").val(($("#unitPrice").val() - 0) * ($(thisInput).val() - 0));
			}else{
				$("#amountMoney").val("");
			}
			
		}

		/*计算商品金额*/
		function countGoodsMoney(thisInput) {
			if(isnotEmpty($(thisInput).val())){
				pressInteger(thisInput);
				let count = $(thisInput).val();
				let unitPrice = $(thisInput).parents("tr").find(".goodsUnitPrice").html();
				$(thisInput).parents("tr").find(".goodsAllPrice").val(count * unitPrice);
			}else{
				$(thisInput).parents("tr").find(".goodsAllPrice").val("");
			}
		}
	</script>

</html>