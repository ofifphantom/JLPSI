<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8" />
		<title>报损单</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="../../../../css/bootstrap.min.css" />
		<link rel="stylesheet" href="../../../../css/ace.min.css" />
		<link rel="stylesheet" href="../../../../css/style.css" />
		<link rel="stylesheet" href="../../../../css/style_i.css" />
		<link rel="stylesheet" href="../../../../font/css/font-awesome.min.css" />
		<link rel="stylesheet" href="../../../../js/layer/skin/layer.css" />
		<!--[if IE 7]>
		  <link rel="stylesheet" href="../../../../font/css/font-awesome-ie7.min.css" />
		  <link rel="stylesheet" href="../../../../css/ace-ie.min.css" />
		<![endif]-->

		<link rel="stylesheet" href="../../../../css/mine/all.css" />
		<link rel="stylesheet" href="../../../../css/mine/public.css" />

		<script src="../../../../js/jquery-1.10.2.min.js"></script>
		<script src="../../../../js/bootstrap.min.js"></script>
		<script src="../../../../js/typeahead-bs2.min.js"></script>
		<script src="../../../../js/jquery.dataTables.min.js"></script>
		<script src="../../../../js/jquery.dataTables.bootstrap.js"></script>
		<script src="../../../../js/layer/layer.js" type="text/javascript"></script>
		<script src="../../../../js/laydate/laydate.js" type="text/javascript"></script>

		<script src="../../../../script/public.js" type="text/javascript"></script>
		<script src="../../../../script/Bill.js" type="text/javascript"></script>
		<script src="../../../../script/watermark.js" type="text/javascript"></script>

		<link href="../../../../js/jQuery-searchableSelect/jquery.searchableSelect.css" rel="stylesheet" type="text/css">
		<script src="../../../../js/jQuery-searchableSelect/jquery.searchableSelect.js"></script>

		<style type="text/css">
			#allgoodDivEdit .jl-panel {
				position: relative;
			}
			
			#detailDiv,
			#editDiv {
				margin: 50px auto;
			}
			.col-xs-5{
				text-align: left !important; 
			}
		</style>

	</head>

	<body class="content">
		<div class="page-content clearfix">
			<div id="Member_Ratings">
				<div class="d_Confirm_Order_style" style="margin-top:10px;">
					<h4 class="text-title">报损单</h4>
					<div class="search-div clearfix">
						<div class="clearfix">
							<span class="l_f"> 
							仓库： <select class="warehouse">
								<option value="-1">--全部仓库--</option>
							</select>
							</span>
							<span class="l_f"> 
								日期： <input type="text"  value="" id="dateSearch" placeholder="请选择日期" readonly="readonly" />
							</span>
							<span class="l_f"> 
								制单人： <input type="text"  value="" onblur="cky(this)" />
							</span>
							<span class="r_f"> 
								<input type="button"  class="btncss btn_search" value="搜索" />
							</span>
						</div>

					</div>
					<div class="opration-div clearfix">

						<span class="r_f"> 
							<button type="button" class="btncss jl-btn-defult" onclick="reportLossAdd()"><i class="fa fa-plus"></i> 新增</button>
						</span>

					</div>
					<div class="table_menu_list">
						<table class="table table-striped table-hover col-xs-12" id="datatable">
							<thead class="table-header">
								<tr>
									<th>单号</th>
									<th>日期</th>
									<th>仓库</th>
									<th>合计金额</th>
									<th>摘要</th>
									<th>制单人</th>
									<th>审核人</th>
									<th width="25%">操作</th>
								</tr>

							</thead>
							<tbody>
								<tr>
									<td>
										<span class="look-span" onclick="reportLossDetail()">PO.2017.09.00054</span>
									</td>
									<td>2017.10.02</td>
									<td>冷库</td>
									<td>AAA</td>
									<td>212454878</td>
									<td>212454878</td>
									<td>212454878</td>
									<td>
										<input type="button" class="btncss edit" onclick="reportLossEdit()" value="编辑" />
										<input type="button" class="btncss edit" onclick="reportLossDel()" value="删除" />
										<input type="button" class="btncss edit" onclick="orderPrint()" value="打印" />
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!--详情 -->
		<div id="detailDiv" style="display: none;">
			<div class="print-content">
				
			<form class="container">
				<h3 class="print-title">报损单</h3>
				<div class="row">
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">单号：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">日期：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">仓库：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
				</div>
				<div id="allgoodDivDetail">
					<table class="table table-bordered table-striped table-hover col-xs-12" border="" cellspacing="0" cellpadding="0">
						<tbody>
							<tr>
								<th>货品编码</th>
								<th>货品名称</th>
								<th>规格</th>
								<th>单位</th>
								<th>报损数量</th>
								<th>单价</th>
								<th>金额</th>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
						</tbody>
					</table>

				</div>
				<div class="row">
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">部门：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">业务员：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">制单人：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
				</div>
				<div class="row">	
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">摘要：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<label for="" class="col-xs-5 control-label">审核人：</label>
							<div class="col-xs-7">

							</div>
						</div>
					</div>
					
				</div>

			</form>

				
			</div>
		</div>

		<div id="editDiv" style="display: none;">
			<form class="container">
				<div class="row jl-title">
					<span>基本信息</span>
				</div>
				<div id="headEdit" class="jl-panel">
					<div class="row">
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">仓库</label>
								<div class="col-xs-8">
									<select id="warehouse" class="form-control warehouse" onchange="onWarehouseChange(this)">
										<option value="-1">--请选择仓库--</option>
										<option value="A">A仓库</option>
									</select>
								</div>
							</div>
						</div>
					</div>

				</div>

				<div class="row">
					<div class="jl-title l_f" style="text-align: left;">
						<span>货品</span>
					</div>
					<div class="r_f" style="margin-top: 15px;">
						<button type="button" class="btncss jl-btn-importent" onclick="goodsAddEdit()">新增</button>
					</div>
					<div class="r_f" style="margin-top: 14px;">
						<div class="form-group">
							<div class="">
								<select id="edit_goods" class="form-control" disabled="disabled">
									<option value="-1">--请先选择仓库--</option>
								</select>
							</div>
						</div>
					</div>

				</div>
				<table class="table table-bordered table-striped table-hover col-xs-12" border="" cellspacing="0" cellpadding="0">
					<tbody id="goodsTbody">
						<tr>
							<th>货品编码</th>
							<th>货品名称</th>
							<th>规格</th>
							<th>单位</th>
							<th>报损数量</th>
							<th>单价</th>
							<th>金额</th>
							<th>操作</th>
						</tr>
						<tr class="tipTr">
							<td colspan="8">请先选择商品</td>
						</tr>
					</tbody>
				</table>
				<div class="row jl-title">
					<span>其他</span>
				</div>
				<div id="footerEdit" class="jl-panel">
					<div class="row">
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">部门</label>
								<div class="col-xs-8">
									<select class="form-control">
										<option value="-1">--请选择部门--</option>
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">业务员</label>
								<div class="col-xs-8">
									<select class="form-control">
										<option value="-1">--请选择业务员--</option>
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">制单人</label>
								<div class="col-xs-8">
									<input class="form-control" type="text" onblur="cky(this)" />
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label for="" class="col-xs-4 control-label">摘要</label>
								<div class="col-xs-8">
									<input class="form-control" type="text" onblur="cky(this)" />
								</div>
							</div>
						</div>
					</div>
				</div>
			</form>
		</div>

		<!--打印-->
		<div id="printDiv" style="display: none;">
		</div>

	</body>

	<script>
		let goodsArr = [];
		$(function() {
			latdate("#dateSearch");
			
			

		})
		/*新增*/
		function reportLossAdd() {
			layer.open({
				type: 1,
				title: "新增报损单",
				closeBtn: 1,
				area: ['100%', '100%'],
				content: $("#editDiv"),
				btn: ['提交', '取消'],
				yes: function(index) {
					layer.close(index);

					laysuccess("新增");
					clearForm("editDiv", "");
				},
				end: function(index, layero) {
					layer.close(index);
					clearForm("editDiv", "");
					clearGoods();
					clearSearchableSelect("edit_goods");

				}
			});
		}
		/*编辑*/
		function reportLossEdit(){
			layer.open({
				type: 1,
				title: "编辑报损单",
				closeBtn: 1,
				area: ['100%', '100%'],
				content: $("#editDiv"),
				btn: ['提交', '取消'],
				yes: function(index) {
					layer.close(index);

					laysuccess("编辑");
					clearForm("editDiv", "");
				},
				end: function(index, layero) {
					layer.close(index);
					clearForm("editDiv", "");
					clearGoods();
					clearSearchableSelect("edit_goods");

				}
			});
		}

		/*详情*/
		function reportLossDetail() {
			layer.open({
				type: 1,
				title: "报损单详情",
				closeBtn: 1,
				area: ['100%', '100%'],
				content: $("#detailDiv"),
				btn: ['关闭']
			});
		}
		
		/*删除*/
		function reportLossDel(){
			publicMessageLayer("删除", function() {
				/*请在此处添加删除操作*/

			})
		}

		
		
		/*添加商品*/
		function goodsAddEdit() {
			let goodsId = $("#edit_goods").val();
			let name = $("#edit_goods option:selected").attr("attr-name");
			let type = $("#edit_goods option:selected").attr("attr-type");
			let unit = $("#edit_goods option:selected").attr("attr-unit");
			let count = $("#edit_goods option:selected").attr("attr-count");
			let price = $("#edit_goods option:selected").attr("attr-price");
			let money = $("#edit_goods option:selected").attr("attr-money");
			
			if($("#warehouse").val()=="-1"){
				layfail("请先选择仓库!");
			}else if(goodsId == -1) {
				layfail("请先选择商品!");
			} else if(!checkRepeat(goodsId)) {
				$(".tipTr").remove();
				goodsArr.push(goodsId);
				$("#goodsTbody").append('<tr><td class="goodsId">' + goodsId + '</td><td>' + name + '</td><td>' 
				+ type + '</td><td>' + unit+ '</td>'
				+'<td><input type="text" class="form-control" onkeyup="countGoodsMoney(this)"/></td><td class="goodsUnitPrice">' + price + '</td>' 
				+'<td><input type="text" class="goodsAllPrice form-control" placeholder="请先填写数量" disabled="disabled"/></td>' 
				+ '<td>' +'<input type="button" class="btncss edit" onclick="goodsDel(this)" value="删除" /></td></tr>');
			} else {
				layfail("请勿重复选择商品！");
			}
		}

		/*删除商品*/
		function goodsDel(thisbtn) {
			let goodsId = $(thisbtn).parents("tr").find(".goodsId").html();
			goodsArr.remove(goodsId);
			$(thisbtn).parents("tr").remove();
			if($("#goodsTbody tr").length == 1) {
				$("#goodsTbody").append('<tr class="tipTr"><td colspan="8">请先选择商品</td></tr>');
			}
		}

		/*查重*/
		function checkRepeat(id) {
			let flag = false;
			for(var i in goodsArr) {
				if(goodsArr[i] == id) {
					flag = true;
				}
			}
			return flag;
		}

		/*清空商品*/
		function clearGoods() {
			$("#goodsTbody").html('<tr><th>货品编码</th><th>货品名称</th><th>规格</th><th>单位</th><th>报损数量</th><th>单价</th><th>金额</th><th>操作</th></tr>' +
				'<tr class="tipTr"><td colspan="8">请先选择商品</td></tr>');
			goodsArr = [];
		}
		
		/*仓库change值改变事件*/
		function onWarehouseChange(thisSelect){
			clearGoods();
			if($(thisSelect).val()==-1){
				$('#edit_goods').parent().html('<select id="edit_goods" class="form-control" disabled="disabled"><option value="-1">--请先选择仓库--</option></select>');
			}else{
				$('#edit_goods').parent().html('<select id="edit_goods" class="form-control"><option value="-1">--请选择商品--</option></select>');
				
				/*请在此处为商品下拉框赋值*/
				$('#edit_goods').append('<option value="44" attr-name="name" attr-type="type" attr-unit="unit" attr-count="10" attr-price="10" attr-money="20">44</option>')
				
				$('#edit_goods').searchableSelect();
			}
		}
		
		/*计算商品金额*/
		function countGoodsMoney(thisInput) {
			if(isnotEmpty($(thisInput).val())){
				pressInteger(thisInput);
				let count = $(thisInput).val();
				let unitPrice = $(thisInput).parents("tr").find(".goodsUnitPrice").html();
				$(thisInput).parents("tr").find(".goodsAllPrice").val(count * unitPrice);
			}else{
				$(thisInput).parents("tr").find(".goodsAllPrice").val("");
			}
		}
		
		/*打印*/
		function orderPrint() {
			/*请修改ur地址以及打印次数*/
			
			$.ajax({
				type: "get",
				url: "../../../../json/fornData.json",
				async: true,
				success: function(res) {
					console.log(res)
					let bill = new Bill(res);
					let $content = bill.toPrint();
					$("#printDiv").html("");
					$("#printDiv").append($content);
					$("#printDiv .container").append(watermark("打印次数：" + "12" + "次", "#pickingList"));
					$('.watermark>div').fontFlex(80, 100, 10);
				}
			});
			layer.open({
				type: 1,
				title:"盘点单详情",
				closeBtn: 1,
				area: ['100%', '100%'],
				content: $("#printDiv"),
				btn: ['打印', '关闭'],
				yes: function(index) {
					$("#printDiv .container").printArea();
				},
				end: function(index, layero) {
					layer.close(index);
					$("#printDiv").html("");
				}
			});

		}
	</script>

</html>